# 4S 18650 BMS - 基于 STM32F103C8T6 + BQ7692003

这是一个基于 STM32F103C8T6 微控制器和 BQ7692003 AFE 芯片的 4 串 18650 电池管理系统（BMS）。

## 硬件规格

| 组件 | 型号/规格 |
|------|----------|
| 主控芯片 | STM32F103C8T6 |
| AFE 芯片 | BQ7692003 |
| 电池配置 | 4S 18650 (12.8V 标称) |
| 通信接口 | I2C (BQ7692003), UART (数据输出) |
| 工作电压 | 12V - 16.8V |

## 功能特性

### 电池监测
- **4 串单体电压监测** - 实时监测每节电池电压，精度可达 mV 级
- **电流测量** - 支持充电/放电电流监测，基于库仑计原理
- **温度监测** - 支持外部 NTC 温度传感器监测电池温度

### 保护与控制
- **MOS 控制** - 支持充电/放电 MOS 管独立控制
- **按键控制** - 通过按键切换 MOS 开关状态
- **状态指示** - LED 指示通信状态和 MOS 工作状态

### SOC 计算
- **三段式拟合算法** - 根据最低单体电压计算电池剩余容量
  - 3.0V - 3.6V: 陡降区 (0% - 10%)
  - 3.6V - 3.8V: 平台区 (10% - 60%)
  - 3.8V - 4.15V: 高压区 (60% - 100%)

### 数据通信
- **UART 数据输出** - 定时发送电池状态数据
- **CRC 校验** - I2C 通信采用 CRC8 校验，确保数据可靠性

## 通信协议

### UART 数据包格式

数据包长度为 3 字节：`[ID, 高字节, 低字节]`

| ID | 数据类型 | 单位 | 说明 |
|----|----------|------|------|
| 1 | 电池1电压 | mV | VC1 单体电压 |
| 2 | 电池2电压 | mV | VC2 单体电压 |
| 3 | 电池3电压 | mV | VC3 单体电压 |
| 4 | 电池4电压 | mV | VC4 单体电压 |
| 5 | 电流 | mA | 正值=充电，负值=放电 |
| 6 | 温度 | 0.1°C | 实际温度 × 10 |
| 7 | SOC | 0.1% | 剩余容量百分比 × 10 |
| 8 | 调试变量 | - | 用于调试的增益值 |

## 引脚定义

### STM32F103C8T6 引脚分配

| 引脚 | 功能 | 说明 |
|------|------|------|
| PA1 | TS1 | BQ7692003 唤醒信号 |
| PA2 | 按键输入 | 外部中断，控制 MOS 开关 |
| PA3 | 充电 MOS LED | 充电 MOS 状态指示 |
| PA4 | 放电 MOS LED | 放电 MOS 状态指示 |
| PA5 | 串口发送 LED | 数据发送指示 |
| PA6 | 通信状态 LED | BQ7692003 通信状态 |
| PB6 | I2C1_SCL | I2C 时钟线 |
| PB7 | I2C1_SDA | I2C 数据线 |
| PA9 | USART1_TX | UART 发送 |
| PA10 | USART1_RX | UART 接收 |

### BQ7692003 I2C 地址
- 7 位地址：`0x08`
- HAL 库使用地址：`0x10` (左移一位)

## 编译与烧录

### 开发环境
- STM32CubeIDE / Keil MDK / IAR EWARM

### 编译步骤
1. 使用 STM32CubeIDE 打开项目
2. 选择 Release 或 Debug 配置
3. 点击 Build 编译项目

### 烧录步骤
1. 使用 ST-Link 连接开发板
2. 选择生成的 .hex 或 .bin 文件
3. 点击 Download 烧录到芯片

## 注意事项

1. **首次使用** - 上电后需要等待约 1 秒让 BQ7692003 完成初始化
2. **通信失败** - 如果通信失败，PA6 LED 会以 500ms 间隔闪烁
3. **MOS 控制** - 按键切换 MOS 状态时，会自动清除故障标志
4. **电压范围** - 单体电池电压建议保持在 3.0V - 4.2V 之间
5. **温度保护** - 建议在应用层添加温度保护逻辑
6. **校准参数** - BQ7692003 内部增益和偏移参数会在启动时自动读取

## 许可证

本项目基于 STM32 HAL 库开发，遵循相应的开源许可证。

## 作者

GTLordLL

## 项目链接

https://github.com/GTLordLL/18650-4s-BMS-bq7692003-stm32f103c8t6
